// prisma/schema/attFerraillage.prisma

enum FerMouvementType {
  LIVRAISON
  TRANSFERT
  AJUSTEMENT
}

/**
 * =========================================================
 * RAPPORT 1 : ETAT DE FER LIVRE AU CHANTIER
 * =========================================================
 */

model FerEtatChantier {
  id String @id @default(cuid())

  // parent projet/chantier
  rapportId String
  rapport   FerRapport @relation(fields: [rapportId], references: [id], onDelete: Cascade)

  // données propres à CE document
  etatDate DateTime? // date imprimée en haut (ex: 25-11-2025)

  mouvements FerMouvement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rapportId])
  @@index([rapportId, etatDate])
}

model FerMouvement {
  id     String          @id @default(cuid())
  etatId String
  etat   FerEtatChantier @relation(fields: [etatId], references: [id], onDelete: Cascade)

  date DateTime
  type FerMouvementType @default(LIVRAISON)

  bonLivraison String?
  note         String?

  lignes FerMouvementLigne[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([etatId, date])
  @@index([bonLivraison])
}

model FerMouvementLigne {
  id          String       @id @default(cuid())
  mouvementId String
  mouvement   FerMouvement @relation(fields: [mouvementId], references: [id], onDelete: Cascade)

  diametreId String
  diametre   FerDiametre @relation(fields: [diametreId], references: [id])

  qty Decimal // autoriser négatif (TRANSFERT) ex: -3.500

  @@unique([mouvementId, diametreId])
  @@index([diametreId])
}

/**
 * =========================================================
 * RAPPORT 2 : Quantité restante non confectionné (snapshots)
 * =========================================================
 */

model FerRestantNonConfectionne {
  id String @id @default(cuid())

  // parent projet/chantier
  rapportId String
  rapport   FerRapport @relation(fields: [rapportId], references: [id], onDelete: Cascade)

  // données propres à CE document
  rapportDate DateTime? // date imprimée (si tu as un "Le: ...")

  snapshots FerRestantSnapshot[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rapportId])
  @@index([rapportId, rapportDate])
}

model FerRestantSnapshot {
  id        String                    @id @default(cuid())
  rapportId String
  rapport   FerRestantNonConfectionne @relation(fields: [rapportId], references: [id], onDelete: Cascade)

  date DateTime
  note String?

  lignes FerRestantLigne[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([rapportId, date])
  @@index([rapportId, date])
}

model FerRestantLigne {
  id         String             @id @default(cuid())
  snapshotId String
  snapshot   FerRestantSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  diametreId String
  diametre   FerDiametre @relation(fields: [diametreId], references: [id])

  qty Decimal

  @@unique([snapshotId, diametreId])
  @@index([diametreId])
}

model User {
  id           String @id @default(cuid())
  email        String @unique
  passwordHash String

  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ModuleKey {
  MODULE_1
  MODULE_2
}

enum SubModuleKey {
  FERRAILLAGE
}

model Module {
  id        String    @id @default(cuid())
  key       ModuleKey @unique
  name      String
  slug      String    @unique
  route     String
  sortOrder Int       @default(100)
  isActive  Boolean   @default(true)

  subscriptions SubscriptionModule[]
  subModules    SubModule[]

  @@index([sortOrder])
}

model SubscriptionModule {
  subscriptionId String
  moduleId       String
  enabledAt      DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id])
  module       Module       @relation(fields: [moduleId], references: [id])

  @@id([subscriptionId, moduleId])
}

model SubModule {
  id        String       @id @default(cuid())
  key       SubModuleKey @unique
  name      String
  slug      String       @unique
  route     String
  sortOrder Int          @default(100)
  isActive  Boolean      @default(true)

  moduleId String
  module   Module @relation(fields: [moduleId], references: [id])

  subscriptions SubscriptionSubModule[]

  @@index([moduleId, sortOrder])
}

model SubscriptionSubModule {
  subscriptionId String
  subModuleId    String
  enabledAt      DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id])
  subModule    SubModule    @relation(fields: [subModuleId], references: [id])

  @@id([subscriptionId, subModuleId])
}

// prisma/schema/ferraillage.prisma

model FerRapport {
  id String @id @default(cuid())

  // MAIN PROJECT DATA (chantier)
  chantierName String
  sousTraitant String?

  // 1 projet -> plusieurs documents/rapports
  etats    FerEtatChantier[]
  restants FerRestantNonConfectionne[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Optionnel (si tu veux éviter doublons):
  // @@unique([chantierName, sousTraitant])

  @@index([chantierName])
}

/**
 * Diamètres illimités: 5, 6, 8, 10, 12, 14, 16, 20, 21, ...
 */
model FerDiametre {
  id       String  @id @default(cuid())
  mm       Int     @unique
  label    String?
  isActive Boolean @default(true)

  mouvementLignes FerMouvementLigne[]
  restantLignes   FerRestantLigne[]

  @@index([isActive])
}

datasource db {
  provider = "mysql"
}

generator client {
  provider = "prisma-client-js"
}

enum Plan {
  INDIVIDUAL
  ENTERPRISE
}

enum SubscriptionStatus {
  INACTIVE
  ACTIVE
  EXPIRED
  PAST_DUE
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

model Subscription {
  id               String             @id @default(cuid())
  status           SubscriptionStatus @default(INACTIVE)
  plan             Plan?
  billingCycle     BillingCycle?
  seats            Int                @default(1)
  currentPeriodEnd DateTime?

  users      User[]
  modules    SubscriptionModule[]
  subModules SubscriptionSubModule[] // keep only if you created this model

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
